<html>
	<div class="col-xs-12 text-center">
		<div class="text-center row" id="display">
		</div>
	</div>
</html>

<style>
	@import "/public/styles/drink.css";

	input[type="file"] {
		display: none;
	}

	.custom-file-upload {
		border: 1px solid #ccc;
		display: inline-block;
		padding: 6px 12px;
		cursor: pointer;
		margin: 10px 40% 10px 40%;
		width: 100%;
		font-size: 20px;
		font-style: oblique;
	}
</style>

<script type="module">
    'use strict';

    import EasyDom from '/public/services/dom.js';
    import EasyFetch from '/public/services/fetch.js';
    import EasyState from '/public/services/state.js';
    import EasyNotify from '/public/services/notify.js';

    let newNotify = new EasyNotify();
    let newState = new EasyState();
    let newFetch = new EasyFetch();
    let newDom = new EasyDom();

    let display = newDom.querySelector('#display');
    let configuration = {};
    let socket = io(`${window.location.protocol}//${window.location.hostname}:${window.location.port}`);

    async function displayConfig (elm, config, replace = false){
        configuration = config;
        let container = await newDom.createElm('div', 'drink-container');

        // The date argument is to force the browser to reload the image each time it is requested by treating the
		// date as a hash
        container.innerHTML = `
			    <p>
					<object class="drink-image" data="/api/drink-image/${config.id}?${(new Date()).getTime()}" type="image/png">
					    <img class="drink-image" src="/public/images/default-bottle.png" alt="example">
					</object>
				</p>

				<div class="row text-center">
					<label class="custom-file-upload">
						<input type="file" accept="image/*" onchange="changeImage('${config.id}')"/>
						Change Image
					</label>
				</div>

                <h2 class="drink-title">
                	<input type="text" id="drink-title" value="${config.displayName}">
				</h2>
                <div class="drink-description">
                	<textarea type="text" id="drink-description">${config.description}</textarea>
				</div>
                <div class="drink-pin">
                	<label>Pin:</label> <input type="number" class="text-center" value="${config.pin || -1}"></input>
				</div>

				<div>
					<button type="button" class="btn btn-outline-primary" onmousedown="save('${config.id}')" ontouchstart="save('${config.id}')">
						Save
					</button>
				</div>
             `;

        if (replace === true) {
            elm.innerHTML = '';
		}

        elm.appendChild(container);
    }

    function getConfig () {
        let name = newDom.querySelector('.drink-title input').value;
        let description = newDom.querySelector('.drink-description textarea').value;
        let pin = newDom.querySelector('.drink-pin input').value;
		let conf = {
            ...configuration,
            name,
            description,
            pin
        };

		delete conf.image;
        return conf;
    }

    document.save = function () {
		let finalConfig = getConfig();

        return newFetch.postJson(`drinks`, { config: finalConfig }).then(config => {
            return changeImage(config.id).then(() => config); //hacky way to pass the config forward
        }).then((config) => {
            newNotify.success('Successfully updated drink config!').show();

            return newState.goToState(`drinks/view`, {
                id: config.id
            });
        }).catch(err => {
            newNotify.error(err.message).show();
        });
	};

    document.changeImage = function (id) {
        let preview = newDom.querySelector('img'); //selects the query named img
        let file = newDom.querySelector('input[type=file]').files[0]; //sames as here
        let reader = new FileReader();

        if (file) {
            reader.readAsDataURL(file); //reads the data as a URL

            let readyFunc =  () => {
                preview.src = reader.result;
            };

            if (reader.readyState === 2 ) {
                readyFunc();
            } else {
                reader.onloadend = readyFunc;
            }
        }
    };

    let changeImage = (id) => {
        let file = newDom.querySelector('input[type=file]').files[0]; //sames as here

        if (file) {
            return newFetch.put(`drink-image/${id}`, file, {
                'Content-Type': file.type
			}, true)
        }

        return Promise.resolve();
    };

    socket.on('init', function (data) {
        newNotify.info(data).show();
    },);

    displayConfig(display, {
	}).catch(err => {
        newNotify.error(err.message).show();
    });

    window.addEventListener('load',function(){
        let gamepad;

        window.addEventListener('gamepadconnected', function() {
            gamepad = navigator.getGamepads().pop();
        });

        window.addEventListener('gamepaddisconnected', function() {
            gamepad = undefined;
        });
    });
</script>
